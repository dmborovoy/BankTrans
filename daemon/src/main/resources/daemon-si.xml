<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-file="http://www.springframework.org/schema/integration/file"
       xmlns:int-mail="http://www.springframework.org/schema/integration/mail"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/integration      http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/integration/mail http://www.springframework.org/schema/integration/mail/spring-integration-mail.xsd
		http://www.springframework.org/schema/integration/file http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
		http://www.springframework.org/schema/beans            http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/util             http://www.springframework.org/schema/util/spring-util.xsd">

    <int:channel id="bkvEmailPollerChannel"/>
    <int:channel id="bkvFileSplitterChannel">
        <int:interceptors>
            <int:wire-tap channel="bkvEmailNotificationChannel"/>
        </int:interceptors>
    </int:channel>
    <int:publish-subscribe-channel id="bkvEmailNotificationChannel" apply-sequence="true"/>

    <int-mail:inbound-channel-adapter id="poll-for-email"
                                      channel="bkvEmailPollerChannel"
                                      store-uri="imap://${bkv.daemon.email.receiver.username}:${bkv.daemon.email.receiver.password}@${bkv.daemon.email.receiver.host}:${bkv.daemon.email.receiver.port}/INBOX"
                                      should-delete-messages="false"
                                      should-mark-messages-as-read="false"
                                      search-term-strategy="bkvEmailSearchStrategy"
                                      java-mail-properties="javaMailProperties">
        <int:poller cron="${bkv.daemon.email.receiver.schedule}" max-messages-per-poll="${bkv.daemon.email.receiver.max-message-to-poll}"/>
    </int-mail:inbound-channel-adapter>

    <int:chain id="transform-filter-save-parse" input-channel="bkvEmailPollerChannel"
               output-channel="bkvFileSplitterChannel">
        <int:transformer>
            <bean class="com.nxsystems.bank.bkv.daemon.endpoints.BKVEmailTransformer"/>
        </int:transformer>
        <int:filter>
            <bean class="com.nxsystems.bank.bkv.daemon.endpoints.BKVEmailFilter"/>
        </int:filter>
        <int:service-activator>
            <bean class="com.nxsystems.bank.bkv.daemon.endpoints.BKVParser"/>
        </int:service-activator>
        <int:service-activator>
            <bean class="com.nxsystems.bank.bkv.daemon.endpoints.BKVFinalizer"/>
        </int:service-activator>
    </int:chain>

    <int:chain id="split-save" input-channel="bkvFileSplitterChannel">
        <int:splitter id="split">
            <bean class="com.nxsystems.bank.bkv.daemon.endpoints.BKVSplitter"/>
        </int:splitter>
        <int-file:outbound-channel-adapter id="save-as-file"
                                           auto-create-directory="true"
                                           directory-expression="headers.directory"/>
    </int:chain>

    <int:chain id="mail-sender" input-channel="bkvEmailNotificationChannel">
        <int:aggregator ref="bkvAggregator" method="aggregate" send-partial-result-on-expiry="true"
                        group-timeout="${bkv.daemon.email.sender.group-timeout}" empty-group-min-timeout="${bkv.daemon.email.sender.group-timeout}"/>
        <int-mail:header-enricher>
            <int-mail:to value="${bkv.daemon.email.sender.to}"/>
            <int-mail:from value="${bkv.daemon.email.sender.from}"/>
            <int-mail:content-type value="text/plain"/>
        </int-mail:header-enricher>
        <int-mail:outbound-channel-adapter mail-sender="bkvMailSender"/>
    </int:chain>

    <bean id="bkvTransactionSearcher" class="com.nxsystems.bank.bkv.daemon.endpoints.BKVTransactionSearcher"/>

    <int:inbound-channel-adapter id="numbers" ref="bkvTransactionSearcher" method="startSearchErrorTransactions" channel="bkvEmailErrorNotificationChannel">
        <int:poller max-messages-per-poll="1" cron="${bkv.daemon.error.search.schedule}"/>
    </int:inbound-channel-adapter>


    <int:chain id="mail-error-sender" input-channel="bkvEmailErrorNotificationChannel">
        <int-mail:header-enricher>
            <int-mail:to value="${bkv.daemon.email.sender.to}"/>
            <int-mail:from value="${bkv.daemon.email.sender.from}"/>
            <int-mail:content-type value="text/plain"/>
        </int-mail:header-enricher>
        <int-mail:outbound-channel-adapter mail-sender="bkvMailSender"/>
    </int:chain>

    <bean id="bkvMailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl">
        <property name="host" value="${bkv.daemon.email.sender.host}"/>
        <property name="port" value="${bkv.daemon.email.sender.port}"/>
        <property name="username" value="${bkv.daemon.email.sender.username}"/>
        <property name="password" value="${bkv.daemon.email.sender.password}"/>
        <property name="javaMailProperties">
            <props>
                <prop key="mail.smtp.ssl.trust">*</prop>
                <prop key="mail.transport.protocol">smtp</prop>
                <prop key="mail.smtp.auth">${bkv.daemon.email.sender.smtp.auth}</prop>
                <prop key="mail.smtp.ssl.enable">false</prop>
                <prop key="mail.smtp.starttls.enable">true</prop>
                <prop key="mail.debug">false</prop>
            </props>
        </property>
    </bean>

    <util:properties id="javaMailProperties">
        <prop key="mail.store.protocol">imap</prop>
        <prop key="mail.debug">false</prop>
        <prop key="mail.imap.starttls.enable">true</prop>
    </util:properties>

</beans>
